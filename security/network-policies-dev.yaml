# security/network-policies-dev.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cptm8-dev-network-policy
  namespace: cptm8-dev
spec:
  podSelector: {}  # Apply to all pods in namespace
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow intra-namespace communication
  - from:
    - namespaceSelector:
        matchLabels:
          name: cptm8-dev
  # Allow monitoring namespace access
  - from:
    - namespaceSelector:
        matchLabels:
          name: cptm8-monitoring
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow intra-namespace communication
  - to:
    - namespaceSelector:
        matchLabels:
          name: cptm8-dev
  # Allow external HTTPS (for ECR, AWS APIs, etc.)
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow external HTTP (for package downloads, etc.)
  - to: []
    ports:
    - protocol: TCP
      port: 80
  # Allow SMTP for email notifications
  - to: []
    ports:
    - protocol: TCP
      port: 587
    - protocol: TCP
      port: 25
---
# Special network policy for scanning services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: scanner-services-policy
  namespace: cptm8-dev
spec:
  podSelector:
    matchLabels:
      component: scanner
  policyTypes:
  - Egress
  egress:
  # Allow all egress for scanning services (they need to scan external targets)
  - to: []
  # But still restrict ingress to intra-namespace only
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: cptm8-dev
